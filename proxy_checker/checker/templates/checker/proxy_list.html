<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socks Checker</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'checker/styles.css' %}">
    <script>
        // Fetch data from API and trigger proxy check
        function checkProxies(singleCheck = true) {
            fetch('/api/data/', {
                method: 'GET', // Or POST if necessary
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);  // Display success message
                    // Optionally, update the table without reloading
                    fetchProxies();  // Fetch updated proxy data
                } else {
                    alert('Ошибка при проверке прокси');
                }
            })
            .catch(error => {
                alert('Ошибка: ' + error);
            });
        }

        // Fetch updated proxy data (after proxy check)
        function fetchProxies() {
            fetch('/api/proxies/')  // Make sure to create this API endpoint
                .then(response => response.json())
                .then(proxies => {
                    const tbody = document.getElementById('results-body');
                    tbody.innerHTML = '';  // Clear existing rows

                    proxies.forEach((proxy, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${proxy.ip}</td>
                            <td>${proxy.port}</td>
                            <td>${proxy.protocol}</td>
                            <td>${proxy.response_time}</td>
                            <td>${proxy.anonymity}</td>
                            <td>${proxy.country}</td>
                            <td>${proxy.country_code}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    alert('Ошибка при загрузке прокси данных: ' + error);
                });
        }

        // Start continuous proxy check
        let intervalId;
        function startContinuousCheck() {
            intervalId = setInterval(() => {
                checkProxies(false);
            }, 60000);  // Check every 60 seconds
        }

        // Stop continuous proxy check
        function stopContinuousCheck() {
            clearInterval(intervalId);
        }

        // Change page functionality (for pagination)
        let currentPage = 1;
        const pageSize = 10;

        function changePage(increment) {
            const newPage = currentPage + increment;
            const maxPage = Math.ceil(proxies.length / pageSize);
            if (newPage > 0 && newPage <= maxPage) {
                currentPage = newPage;
                renderTable(currentPage);
            }
        }
    </script>
</head>
<body>
    <header>
        <h1>Socks Checker</h1>
    </header>

    <nav>
        <a href="#home">Проверка</a>
        <a href="#about">Описание</a>
        <a href="#faq">FAQ</a>
    </nav>

    <div class="container">
        <h2>Проверка Прокси</h2>
        <button onclick="checkProxies(true)">Начать проверку</button>
        <button onclick="stopContinuousCheck()">Остановить проверку</button>

        <h3>Проверенные Прокси</h3>
        <table>
            <thead>
                <tr>
                    <th>№</th>
                    <th>IP Адрес</th>
                    <th>Порт</th>
                    <th>Протокол</th>
                    <th>Время ответа</th>
                    <th>Анонимность</th>
                    <th>Страна</th>
                    <th>Код страны</th>
                </tr>
            </thead>
            <tbody id="results-body">
                <!-- Результаты проверки будут добавлены здесь динамически -->
                {% for proxy in proxies %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ proxy.ip }}</td>
                    <td>{{ proxy.port }}</td>
                    <td>{{ proxy.protocol }}</td>
                    <td>{{ proxy.response_time }}</td>
                    <td>{{ proxy.anonymity }}</td>
                    <td>{{ proxy.country }}</td>
                    <td>{{ proxy.country_code }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
    <div class="timer">
        <p>Всего проверено {start} из {total_proxies} прокси, прошло {hours} часов {minutes} минут {seconds} секунд</p>
        <p>До окончания проверки осталось приблизительно {remaining_hours} часов {remaining_minutes} минут {remaining_seconds} секунд</p>
    </div>

    <div class="txturl">
        <a href="http://127.0.0.1/api.txt">Ссылка на список проверенных прокси</a>
    </div>

    <footer>
        <p>&copy; 2025 Socks Checker. Mashn_hu58. ITstep.by.</p>
    </footer>
</body>
</html>
