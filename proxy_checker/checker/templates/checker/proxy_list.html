{% extends 'checker/base.html' %}

{% block content %}
<div class="container">
    <h2>Проверка Прокси</h2>

    <!-- Start/Stop Buttons -->
    <div class="buttons">
        <button class="button start" onclick="startProxyCheck()">Начать проверку</button>
        <button class="button stop" onclick="stopProxyCheck()">Остановить проверку</button>
    </div>

    <!-- Proxy List Table -->
    <h3>Проверенные Прокси</h3>
    <table>
        <thead>
            <tr>
                <th>IP</th>
                <th>Порт</th>
                <th>Протокол</th>
                <th>Время ответа</th>
                <th>Анонимность</th>
                <th>Страна</th>
                <th>Код страны</th>
                <th>Дата проверки</th>
                <th>Время проверки</th>
            </tr>
        </thead>
        <tbody id="proxy-table-body">
            {% for proxy in proxies %}
                <tr>
                    <td>{{ proxy.ip }}</td>
                    <td>{{ proxy.port }}</td>
                    <td>{{ proxy.protocol }}</td>
                    <td>{{ proxy.response_time }}</td>
                    <td>{{ proxy.anonymity }}</td>
                    <td>{{ proxy.country }}</td>
                    <td>{{ proxy.country_code }}</td>
                    <td>{{ proxy.date_checked }}</td>
                    <td>{{ proxy.time_checked }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Timer Display -->
<div class="timer" id="timer">
    <p>Всего проверено 0 из 0 прокси. Примерное время до окончания проверки: 0 часов 0 минут 0 секунд.</p>
</div>

<div>
    <p>Список проверенных прокси в формате txt можно получить по ссылке
        <a href="{% url 'generate_proxy_list' %}">Download Proxy List</a>
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to start proxy check
    function startProxyCheck() {
        fetch('/start-proxy-check/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message);
            fetchProxies();
            fetchTimer();
        });
    }

    // Function to stop proxy check
    function stopProxyCheck() {
        fetch('/stop-proxy-check/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log("Proxy check stopped");
        });
    }

    // Function to update the proxy list table
    function fetchProxies() {
        fetch('/api/proxy/')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('proxy-table-body');
                tableBody.innerHTML = ''; // Clear the current table
                data.forEach(proxy => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${proxy.ip}</td>
                        <td>${proxy.port}</td>
                        <td>${proxy.protocol}</td>
                        <td>${proxy.response_time}</td>
                        <td>${proxy.anonymity}</td>
                        <td>${proxy.country}</td>
                        <td>${proxy.country_code}</td>
                        <td>${proxy.date_checked}</td>
                        <td>${proxy.time_checked}</td>
                    `;
                    tableBody.appendChild(row);
                });
                updateTimer(data.length);  // Update the timer based on number of checked proxies
            });
    }

    // Function to update the timer
    function fetchTimer() {
        fetch('/timer/')
            .then(response => response.json())
            .then(data => {
                const timerElement = document.getElementById('timer');
                timerElement.innerHTML = `
                    <p>Всего проверено ${data.total_checked} из ${data.total_proxies} прокси. Примерное время до окончания проверки: ${data.remaining_hours} часов ${data.remaining_minutes} минут ${data.remaining_seconds} секунд.</p>
                `;
            });
    }

    // Initial fetch
    fetchProxies();
    fetchTimer();

    // Set interval to fetch proxies and timer every 10 seconds
    setInterval(fetchProxies, 10000);
    setInterval(fetchTimer, 10000);
</script>
{% endblock %}
