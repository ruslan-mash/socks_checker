{% extends 'checker/base.html' %}

{% block content %}
<div class="container">
    <h2>Проверка Прокси</h2>

    <!-- Кнопки запуска и остановки проверки -->
    <div class="buttons">
        <button class="button start" onclick="startProxyCheck()">Начать проверку</button>
        <button class="button stop" onclick="stopProxyCheck()">Остановить проверку</button>
        <button class="button clean" onclick="cleanOldRecords()">Очистить старые записи</button>
    </div>

    <!-- Таблица списка прокси -->
    <h3>Проверенные Прокси</h3>
    <div class="table-container">
        <table id="proxy-table" class="display">
            <thead>
                <tr>
                    <th>IP</th>
                    <th>Порт</th>
                    <th>Протокол</th>
                    <th>Время ответа</th>
                    <th>Анонимность</th>
                    <th>Страна</th>
                    <th>Код страны</th>
                    <th>Дата проверки</th>
                    <th>Время проверки</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Отображение таймера -->
<div class="timer" id="timer">
    <p>Всего проверено 0 из 0 прокси. Примерное время до окончания проверки: 0 часов 0 минут 0 секунд.</p>
</div>

<div>
    <p>Список проверенных прокси в формате txt можно получить по <a href="{% url 'generate_txt_list' %}">ссылке</a></p>
</div>
<div>
    <p>Список проверенных прокси в формате json можно получить по <a href="{% url 'generate_json_list' %}">ссылке</a></p>
</div>
{% endblock %}

{% block scripts %}
<!-- Подключение стилей и скриптов для DataTable -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>

<script>
    // Функция запуска проверки прокси
    function startProxyCheck() {
        fetch('/start-proxy-check/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        })
        .then(response => response.json())
        .then(data => {
            console.log('Проверка началась:', data);
            $('#proxy-table').DataTable().ajax.reload();
            updateTimer();
            document.querySelector('.start').disabled = true;
            document.querySelector('.stop').disabled = false;
        })
        .catch(error => console.error('Ошибка:', error));
    }

    // Функция остановки проверки прокси
    function stopProxyCheck() {
        fetch('/stop-proxy-check/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        })
        .then(response => response.json())
        .then(data => {
            console.log('Проверка остановлена:', data);
            document.querySelector('.start').disabled = false;
            document.querySelector('.stop').disabled = true;
        })
        .catch(error => console.error('Ошибка:', error));
    }

    // Функция очистки старых записей
    function cleanOldRecords() {
        fetch('/clean-old-records/', {
            method: 'DELETE',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            $('#proxy-table').DataTable().ajax.reload();
        })
        .catch(error => console.error('Ошибка:', error));
    }

        // Инициализация DataTable
    $(document).ready(function() {
    const table = $('#proxy-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "/proxies/", // URL для получения данных
            "type": "GET",
            "dataSrc": function(json) {
                console.log(json);  // Просмотр ответа от сервера в консоли

                // Преобразуем данные в формат, который ожидает DataTable
                return json.results ? json.results.data : [];
            }
        },
        "columns": [
            { "data": "ip" },
            { "data": "port" },
            { "data": "protocol" },
            { "data": "response_time" },
            { "data": "anonymity" },
            { "data": "country" },
            { "data": "country_code" },
            { "data": "date_checked" },
            { "data": "time_checked" }
        ],
        "language": {
            "decimal": "",
            "emptyTable": "Нет данных",
            "info": "Показано с _START_ до _END_ из _TOTAL_ записей",
            "infoEmpty": "Показано с 0 до 0 из 0 записей",
            "infoFiltered": "(отфильтровано из _MAX_ записей)",
            "lengthMenu": "",
            "loadingRecords": "Загрузка...",
            "paginate": {
                "first": "Первая",
                "last": "Последняя",
                "next": "Следующая",
                "previous": "Предыдущая"
            }
        },
        "paging": true,
        "pageLength": 8,
        "stateSave": true,
        "ordering": true, // Включить сортировку
        "searching": false,
        "pagingType": "simple",  // Используем простой тип пагинации
        "drawCallback": function(settings) {
            // Получаем данные о количестве записей
            const totalRecords = settings.json.count && !isNaN(settings.json.count) ? settings.json.count : 0;  // Используем count из ответа сервера или 0, если count не является числом
            const filteredRecords = settings.json.count && !isNaN(settings.json.count) ? settings.json.count : 0;  // Используем count из ответа сервера или 0, если count не является числом
            const pageLength = settings._iDisplayLength;
            const totalPages = Math.ceil(totalRecords / pageLength);  // Всего страниц
            const startRecord = settings._iDisplayStart + 1; // Первая отображаемая запись
            const endRecord = Math.min(settings._iDisplayStart + settings._iDisplayLength, totalRecords); // Корректируем для последней записи, учитывая количество записей на странице

            // Обновляем информацию о количестве записей
            $('#proxy-table_info').text(`Показано с ${startRecord} до ${endRecord} из ${totalRecords} записей. Всего страниц: ${totalPages}`);
        }

    });

    updateTimer();  // Ensure the timer updates on page load
});

    // Функция обновления таймера
    function updateTimer() {
        fetch('/timer/')
            .then(response => response.json())
            .then(data => {
                const timerDiv = document.getElementById('timer');
                timerDiv.innerHTML = `
                    <p>Всего проверено ${data.total_checked} из ${data.total_proxies} прокси.
                    Примерное время до окончания проверки: ${data.remaining_hours} часов
                    ${data.remaining_minutes} минут ${data.remaining_seconds} секунд.</p>
                `;
            })
            .catch(error => console.error('Ошибка обновления таймера:', error));
    }
</script>
{% endblock %}
